<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<title>모바일 육성 시뮬레이터 (TXT 스펙 구현)</title>
<style>
  :root{
    --bg:#0f1115;
    --panel:#171a21;
    --muted:#8a93a6;
    --text:#eef2ff;
    --accent:#6aa7ff;
    --accent2:#88f7c1;
    --danger:#ff6a6a;
    --warn:#ffc463;
    --ok:#7cd992;
    --btn:#222735;
    --btn2:#2a3142;
    --disabled:#3a4155;
    --line:#262b38;
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Apple SD Gothic Neo, 'Noto Sans KR', sans-serif;-webkit-font-smoothing:antialiased}
  .wrap{max-width:760px;margin:0 auto;padding:10px 10px 80px}
  header{
    display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;
    background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px 10px;
    position:sticky; top:0; z-index:5; backdrop-filter: blur(6px);
  }
  header .cell{
    display:flex;flex-direction:column;gap:2px;min-width:0
  }
  .label{font-size:12px;color:var(--muted)}
  .value{font-size:15px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}
  .tag{display:inline-block;border:1px solid var(--line);background:#12141b;border-radius:999px;padding:2px 8px;font-size:12px;color:var(--muted);margin-left:6px}
  details.stats{
    margin-top:10px;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden
  }
  details.stats summary{
    list-style:none;padding:12px 14px;cursor:pointer;font-weight:700
  }
  details.stats[open] summary{border-bottom:1px solid var(--line)}
  .stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:12px}
  .stat{background:var(--btn);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
  .stat .nm{font-size:12px;color:var(--muted)}
  .stat .val{font-size:16px;font-weight:800}
  .img-stage{
    margin-top:10px;background:var(--panel);border:1px solid var(--line);border-radius:12px;
    height:50vh; min-height:320px; display:flex;align-items:center;justify-content:center;overflow:hidden; position:relative;
  }
  .img-stage img{max-width:100%;max-height:100%;object-fit:contain; display:block}
  .actions{
    margin-top:10px;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden
  }
  .section-title{padding:10px 12px;border-bottom:1px solid var(--line);font-weight:800}
  .btns{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:12px}
  button{
    background:var(--btn2); color:var(--text); border:1px solid var(--line); padding:10px 8px; border-radius:10px;
    font-weight:700; font-size:14px; cursor:pointer; transition:transform .02s ease;
  }
  button:hover{transform:translateY(-1px)}
  button:active{transform:translateY(0)}
  button.secondary{background:var(--btn)}
  button.accent{background:linear-gradient(180deg, rgba(106,167,255,.2), rgba(106,167,255,.08)); border-color:#2b3a66}
  button.danger{background:linear-gradient(180deg, rgba(255,106,106,.2), rgba(255,106,106,.08)); border-color:#5b2b2b}
  button:disabled{
    background:var(--disabled); color:#99a0b6; border-color:#3a4155; cursor:not-allowed; transform:none
  }
  .note{padding:10px 12px;color:var(--muted);font-size:14px}
  .novel{padding:12px;line-height:1.6; white-space:pre-line}
  .novel .next{margin-top:12px}
  .group{border-top:1px dashed var(--line)}
  .inv{display:flex; flex-wrap:wrap; gap:6px; padding:10px 12px}
  .chip{
    display:inline-flex; gap:6px; align-items:center; border:1px solid var(--line); background:var(--btn);
    padding:6px 10px; border-radius:999px; font-size:12px
  }
  .chip button{font-size:12px; padding:4px 8px}
  .footer{
    position:sticky; bottom:0; left:0; right:0;
    background:linear-gradient(180deg, rgba(15,17,21,.0), rgba(15,17,21,.9) 35%, rgba(15,17,21,1) 100%);
    padding:14px 10px 16px; z-index:5; backdrop-filter: blur(6px);
  }
  .footer .inner{
    max-width:760px; margin:0 auto; display:flex; gap:8px
  }
  .hr{height:1px;background:var(--line);margin:0}
  .hidden{display:none !important}
  .holiday{color:var(--warn);font-weight:800}
  .ok{color:var(--ok);font-weight:800}
  .warn{color:var(--warn);font-weight:800}
  .danger-text{color:var(--danger);font-weight:800}
  .tips{padding:8px 12px; color:var(--muted); font-size:12px; border-top:1px dashed var(--line)}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="cell">
      <div class="label">현재 날짜</div>
      <div class="value" id="dayText">1일째</div>
      <div class="label"><span id="holidayTag" class="tag">평일</span></div>
    </div>
    <div class="cell">
      <div class="label">현재 시간</div>
      <div class="value" id="timeText">아침</div>
    </div>
    <div class="cell">
      <div class="label">현재 레벨</div>
      <div class="value"><span id="levelText">L1</span><span id="marriedTag" class="tag hidden">관계: 부부</span></div>
    </div>
  </header>

  <details class="stats">
    <summary>캐릭터 스탯 (탭하여 펼치기)</summary>
    <div class="stats-grid">
      <div class="stat"><div class="nm">AFF</div><div class="val" id="s_aff">0</div></div>
      <div class="stat"><div class="nm">TRU</div><div class="val" id="s_tru">0</div></div>
      <div class="stat"><div class="nm">MOT</div><div class="val" id="s_mot">0</div></div>
      <div class="stat"><div class="nm">MOOD</div><div class="val" id="s_mood">0</div></div>
      <div class="stat"><div class="nm">STR</div><div class="val" id="s_str">0</div></div>
      <div class="stat"><div class="nm">STM</div><div class="val" id="s_stm">0</div></div>
      <div class="stat"><div class="nm">GLD</div><div class="val" id="s_gld">0</div></div>
    </div>
  </details>

  <div class="img-stage">
    <img id="heroImg" alt="일러스트" src="img/start.png"/>
  </div>

  <div class="actions" id="actionsPanel">
    <div class="section-title" id="modeTitle">행동 선택</div>
    <div id="novelPanel" class="novel hidden">
      <div id="novelText">게임시작<br/>게임시작<br/>게임시작<br/>게임시작</div>
      <button id="btnNextNovel" class="next accent">다음</button>
    </div>

    <div id="dinnerPanel" class="hidden">
      <div class="note">저녁시간이야. 식사를 골라줘.</div>
      <div class="btns">
        <button id="btnDinnerCStore">편의점도시락 (GLD≥18)</button>
        <button id="btnDinnerCook">직접 요리 (GLD≥8 &amp; 밀키트≥1)</button>
        <button id="btnDinnerOut">외식(휴일 전용, GLD≥50)</button>
      </div>
      <div class="tips">조건이 안 되면 버튼이 비활성화돼. 돈이 전혀 없으면 안전장치로 ‘건너뛰기’가 자동 적용돼.</div>
    </div>

    <div id="bathPanel" class="hidden">
      <div class="note">목욕 시간이야. 어떻게 할까?</div>
      <div class="btns">
        <button id="btnBathSolo">혼자서 목욕</button>
        <button id="btnBathTogether">함께 목욕 (L7+, STR≤40, MOOD≥-1.0, 배스밤≥1)</button>
      </div>
    </div>


    <div id="shopPanel" class="hidden">
      <div class="note" id="shopNote">무엇을 살까?</div>
      <div class="btns" id="shopButtons"></div>
      <div class="tips">
        <button id="btnShopCancel" class="secondary" style="width:100%">구경만 하고 나가기</button>
      </div>
    </div>

    <div id="actionGroups">
      <div class="group">
        <div class="section-title">말걸기</div>
        <div class="btns">
          <button id="actTalk">대화하기</button>
          <button id="actPlay">놀아주기</button>
          <button id="actStudy">공부하기</button>
        </div>
      </div>

      <div class="group">
        <div class="section-title">스킨십</div>
        <div class="btns">
          <button id="actPet">쓰다듬기</button>
          <button id="actHug">껴안기</button>
          <button id="actKiss">키스</button>
        </div>
      </div>

      <div class="group">
        <div class="section-title">휴식</div>
        <div class="btns">
          <button id="actRest">그냥 쉬기</button>
          <button id="actTea">차 마시기</button>
          <button id="actSleepSep">따로 자기</button>
          <button id="actSleepTog">함께 자기</button>
        </div>
      </div>

      <div class="group">
        <div class="section-title">일하기</div>
        <div class="btns">
          <button id="actWork">일하기</button>
        </div>
      </div>

      <div class="group">
        <div class="section-title">쇼핑하기</div>
        <div class="btns">
          <button id="actMarket">슈퍼</button>
          <button id="actBook">서점</button>
          <button id="actPharm">약국</button>
        </div>
        <div class="inv" id="inventoryChips"></div>
        <div class="tips">인벤토리에서 피로회복제와 항우울제는 클릭으로 즉시 사용 가능.</div>
      </div>

      <div class="group" id="holidayGroup">
        <div class="section-title">휴일 전용</div>
        <div class="btns">
          <button id="actVolunteer">봉사활동</button>
          <button id="actWalk">산책</button>
          <button id="actPlanetarium">천문관 데이트</button>
          <button id="actCinema">영화관 데이트</button>
          <button id="actAmusement">유원지 데이트</button>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">
    <div class="inner">
      <button id="btnRestart" class="danger" style="flex:1">다시 시작</button>
      <button id="btnQuickSave" class="secondary" style="flex:1">즉시 저장</button>
      <button id="btnQuickLoad" class="secondary" style="flex:1">불러오기</button>
    </div>
  </div>
</div>

<!-- 미리 불러올 이미지들을 모아두는 숨김 컨테이너 -->
<div id="preloadBin" class="hidden" aria-hidden="true"></div>

<script>
(function(){
  'use strict';

  // ---------- Utilities ----------
  const clamp = (v, lo, hi)=> Math.max(lo, Math.min(hi, v));
  const fmt = (n)=> (Math.round(n*100)/100).toString();
  const $ = (sel)=> document.querySelector(sel);
  const byId = (id)=> document.getElementById(id);

  // ---------- Resources (images & stories) ----------
  const IMG = {
    start: "img/start.png",
    talk: "img/talk.png",
    play: "img/play.png",
    study: "img/study.png",
    pet: "img/pet.png",
    hug: "img/hug.png",
    kiss: "img/kiss.png",
    rest: "img/rest.png",
    tea: "img/tea.png",
    sleep_separate: "img/sleep_separate.png",
    sleep_together: "img/sleep_together.png",
    work: "img/work.png",
    market: "img/shop_super.png",
    book: "img/shop_book.png",
    pharm: "img/shop_pharmacy.png",
    volunteer: "img/volunteer.png",
    walk: "img/walk.png",
    date_planetarium: "img/date_planetarium.png",
    date_cinema: "img/date_cinema.png",
    date_amusement: "img/date_amusement.png",
    dinner_cstore: "img/dinner_cstore.png",
    dinner_cook: "img/dinner_cook.png",
    dinner_out: "img/dinner_out.png",
    bath_alone: "img/bath_alone.png",
    bath_together: "img/bath_together.png",
    // Story images
    intro_1:"img/intro_1.png", intro_2:"img/intro_2.png", intro_3:"img/intro_3.png",
    L2_1:"img/L2_1.png", L2_2:"img/L2_2.png", L2_3:"img/L2_3.png",
    L3_1:"img/L3_1.png", L3_2:"img/L3_2.png", L3_3:"img/L3_3.png",
    L4_1:"img/L4_1.png", L4_2:"img/L4_2.png", L4_3:"img/L4_3.png",
    L5_1:"img/L5_1.png", L5_2:"img/L5_2.png", L5_3:"img/L5_3.png",
    L6_1:"img/L6_1.png", L6_2:"img/L6_2.png", L6_3:"img/L6_3.png",
    L7_1:"img/L7_1.png", L7_2:"img/L7_2.png", L7_3:"img/L7_3.png",
    L8_1:"img/L8_1.png", L8_2:"img/L8_2.png", L8_3:"img/L8_3.png",
    married_1: "img/married_1.png",
    married_2: "img/married_2.png",
    married_3: "img/married_3.png"
  };

  const STORIES = {
    intro: [
      "게임시작\\n게임시작\\n게임시작\\n게임시작",
      "게임시작\\n게임시작\\n게임시작\\n게임시작",
      "게임시작\\n게임시작\\n게임시작\\n게임시작"
    ],
    L2: [
      "L2레벨업\\nL2레벨업\\nL2레벨업\\nL2레벨업",
      "L2레벨업\\nL2레벨업\\nL2레벨업\\nL2레벨업",
      "L2레벨업\\nL2레벨업\\nL2레벨업\\nL2레벨업"
    ],
    L3: ["L3레벨업\\nL3레벨업\\nL3레벨업\\nL3레벨업",
         "L3레벨업\\nL3레벨업\\nL3레벨업\\nL3레벨업",
         "L3레벨업\\nL3레벨업\\nL3레벨업\\nL3레벨업"],
    L4: ["L4레벨업\\nL4레벨업\\nL4레벨업\\nL4레벨업",
         "L4레벨업\\nL4레벨업\\nL4레벨업\\nL4레벨업",
         "L4레벨업\\nL4레벨업\\nL4레벨업\\nL4레벨업"],
    L5: ["L5레벨업\\nL5레벨업\\nL5레벨업\\nL5레벨업",
         "L5레벨업\\nL5레벨업\\nL5레벨업\\nL5레벨업",
         "L5레벨업\\nL5레벨업\\nL5레벨업\\nL5레벨업"],
    L6: ["L6레벨업\\nL6레벨업\\nL6레벨업\\nL6레벨업",
         "L6레벨업\\nL6레벨업\\nL6레벨업\\nL6레벨업",
         "L6레벨업\\nL6레벨업\\nL6레벨업\\nL6레벨업"],
    L7: ["L7레벨업\\nL7레벨업\\nL7레벨업\\nL7레벨업",
         "L7레벨업\\nL7레벨업\\nL7레벨업\\nL7레벨업",
         "L7레벨업\\nL7레벨업\\nL7레벨업\\nL7레벨업"],
    L8: ["L8레벨업\\nL8레벨업\\nL8레벨업\\nL8레벨업",
         "L8레벨업\\nL8레벨업\\nL8레벨업\\nL8레벨업",
         "L8레벨업\\nL8레벨업\\nL8레벨업\\nL8레벨업"],
    married: [
      "부부 에피소드 1\n함께한 시간의 무게가 조용히 실감되는 밤.\n반지를 바라보며 웃는다.\n내일은 더 다정하게.",
      "부부 에피소드 2\n서툰 살림과 익숙한 장난.\n사소한 싸움도 금세 풀린다.\n같은 집, 같은 꿈.",
      "부부 에피소드 3\n둘이서 만든 작은 기념일.\n식탁 위 촛불과 사진 한 장.\n우리가 이루어졌다."
    ]};

  const STORY_IMGS = {
    intro: [IMG.intro_1, IMG.intro_2, IMG.intro_3],
    L2: [IMG.L2_1, IMG.L2_2, IMG.L2_3],
    L3: [IMG.L3_1, IMG.L3_2, IMG.L3_3],
    L4: [IMG.L4_1, IMG.L4_2, IMG.L4_3],
    L5: [IMG.L5_1, IMG.L5_2, IMG.L5_3],
    L6: [IMG.L6_1, IMG.L6_2, IMG.L6_3],
    L7: [IMG.L7_1, IMG.L7_2, IMG.L7_3],
    L8: [IMG.L8_1, IMG.L8_2, IMG.L8_3],
    married: [IMG.married_1, IMG.married_2, IMG.married_3]};

  // Preload all images (placed into hidden DOM to ensure caching)
  function preloadAllImages(){
    const bin = byId('preloadBin');
    const paths = Object.values(IMG);
    for(const src of paths){
      const im = new Image();
      im.src = src;
      im.alt = "preload";
      bin.appendChild(im);
    }
  }

  // ---------- State ----------
  const KEY = 'raisingSimState.v1';
  const defaultState = {
    day: 1,
    timeIndex: 0, // 0 아침, 1 낮, 2 오후, 3 저녁식사, 4 목욕, 5 저녁, 6 밤
    level: 1,
    married:false,
    mode: 'story', // 'story' | 'actions' | 'dinner' | 'bath' | 'shop'
    story: { stage: 'intro', idx: 0, pendingQueue: [] },

    stats: { AFF:0, TRU:0, MOT:0, MOOD:3, STR:0, STM:100, GLD:100 },
    counters: {
      pet:0, hug:0, kiss:0,
      datePlanetarium:0, dateCinema:0, dateAmusement:0
    },
    inventory: {
      toy:0, mealkit:0, bathbomb:0,
      movieTicket:0, amusementTicket:0,
      starGuide:false, ring:false,
      energyDrink:0, antidepressant:0,
      problem:0, tealeaf:0
    },
    lastImage: IMG.start
  };

  let S = load() || structuredClone(defaultState);
  let SHOP = { type:null, title:'', choices:[] };

  // ---------- Time & Holiday ----------
  const TIMES = ['아침','낮','오후','저녁식사','목욕','저녁','밤'];
  function isHoliday(){
    const r = S.day % 7;
    return (r===0 || r===6);
  }

  function nextTime(){
    // advance time by one slot
    S.timeIndex = (S.timeIndex + 1) % TIMES.length;
    if (S.timeIndex === 0){
      // new day
      S.day += 1;
    
  }
    // Enforce dinner/bath modes
    if (TIMES[S.timeIndex] === '저녁식사'){
      S.mode = 'dinner';
    } else if (TIMES[S.timeIndex] === '목욕'){
      S.mode = 'bath';
    } else {
      if (S.mode !== 'story') S.mode = 'actions';
    }
  }

  function skipToNextMorning(){
    // regardless of current time -> next day morning
    S.day += 1;
    S.timeIndex = 0; // 아침
    if (S.mode !== 'story') S.mode = 'actions';
  }

  // ---------- Save/Load ----------
  function save(){ try{ localStorage.setItem(KEY, JSON.stringify(S)); }catch(e){} }
  function load(){ try{ const raw = localStorage.getItem(KEY); return raw? JSON.parse(raw): null; }catch(e){ return null; } }
  function hardReset(){
    S = structuredClone(defaultState);
    save();
    renderAll();
  }

  // ---------- Effects Helper ----------
  function applyDelta(delta){
    const st = S.stats;
    st.AFF += delta.AFF||0;
    st.TRU += delta.TRU||0;
    st.MOT += delta.MOT||0;
    st.MOOD += delta.MOOD||0;
    st.STR += delta.STR||0;
    st.STM += delta.STM||0;
    st.GLD += delta.GLD||0;

    // Clamp bounds
    st.MOOD = clamp(st.MOOD, -3, 3);
    st.STR = clamp(st.STR, 0, 100);
    st.STM = clamp(st.STM, 0, 100);
    st.GLD = Math.max(0, Math.round(st.GLD)); // 금액은 정수화
  }
  
  // ---------- Level Check ----------
  function canLevelUpTo(target){
    const st=S.stats, c=S.counters, inv=S.inventory;
    switch(target){
      case 2: return (st.AFF>=30 && st.TRU>=15 && st.MOT>=5);
      case 3: return (st.AFF>=100 && st.TRU>=45 && st.MOT>=15 && c.pet>=10);
      case 4: return (st.AFF>=200 && st.TRU>=100 && st.MOT>=30 && c.dateCinema>=1 && c.dateAmusement>=1 && c.datePlanetarium>=1);
      case 5: return (st.AFF>=400 && st.TRU>=200 && st.MOT>=50 && c.hug>=5);
      case 6: return (st.AFF>=500 && st.TRU>=250 && st.MOT>=80 && c.kiss>=3);
      case 7: return (st.AFF>=800 && st.TRU>=400 && st.MOT>=120 && c.datePlanetarium>=10);
      case 8: return (st.AFF>=1200 && st.TRU>=600 && st.MOT>=200);
      default: return false;
    }
  }

  function tryLevelUp(){
    let changed = false;
    for(let t=S.level+1; t<=8; t++){
      if (canLevelUpTo(t)){
        S.level = t;
        queueLevelStory(t);
        changed = true;
        break; // 한 번에 한 레벨씩
      }
    }
    return changed;
  }

  function queueLevelStory(newLevel){
    if (newLevel>=2){
      S.story.pendingQueue.push('L'+newLevel);
      // story 모드로 진입
      if (S.mode !== 'story'){
        S.story.stage = S.story.pendingQueue.shift();
        S.story.idx = 0;
        S.mode = 'story';
        setStoryFrame();
      }
    }
  }

  // ---------- Story ----------
  function setStoryFrame(){
    const stage = S.story.stage;
    if(!stage) return;
    const text = (STORIES[stage]||['', '', ''])[S.story.idx] || '';
    const img = (STORY_IMGS[stage]||['', '', ''])[S.story.idx] || IMG.start;
    byId('novelText').innerText = text;
    setImage(img);
    save();
    renderAll();
  }

  function nextStory(){
    const stage = S.story.stage;
    const arr = STORIES[stage] || [];
    if (S.story.idx < arr.length-1){
      S.story.idx += 1;
      setStoryFrame();
    } else {
      // 끝, 다음 큐가 있으면 이어서, 없으면 행동으로
      if (S.story.pendingQueue.length>0){
        S.story.stage = S.story.pendingQueue.shift();
        S.story.idx = 0;
        setStoryFrame();
      } else {
        S.mode = 'actions';
        S.story.stage = null;
        save();
        renderAll();
      }
    }
  }

  // ---------- Image ----------
  function setImage(src){
    S.lastImage = src;
    byId('heroImg').src = src;
  }

  // ---------- Inventory / Shop ----------
  function renderInventory(){
    const inv = S.inventory;
    const chips = [];
    function chip(label, val, canUse, onUse, hint){
      const id = 'chip_'+label.replace(/[^a-zA-Z0-9]/g,'_');
      const btn = canUse? `<button data-chip="${id}">사용</button>`:'';
      const tip = hint? `<span style="color:var(--muted)">${hint}</span>`:'';
      chips.push(`<span class="chip" id="${id}"><strong>${label}</strong> × ${val} ${btn} ${tip}</span>`);
      setTimeout(()=>{
        const el = document.querySelector(`[data-chip="${id}"]`);
        if (el){ el.addEventListener('click', onUse); }
      }, 0);
    }

    // Consumables
    chip('장난감', inv.toy||0, false, null, '');
    chip('문제지', inv.problem||0, false, null, '');
    chip('찻잎', inv.tealeaf||0, false, null, '');
    chip('밀키트', inv.mealkit||0, false, null, '');
    chip('배스밤', inv.bathbomb||0, false, null, '');
    chip('영화티켓', inv.movieTicket||0, false, null, '');
    chip('유원지티켓', inv.amusementTicket||0, false, null, '');
    chip('피로회복제', inv.energyDrink||0, (inv.energyDrink||0)>0, ()=>{
      inv.energyDrink -= 1;
      applyDelta({STM:+100});
      save(); renderAll();
    }, '클릭 시 STM+100');

    chip('항우울제', inv.antidepressant||0, (inv.antidepressant||0)>0, ()=>{
      inv.antidepressant -= 1;
      applyDelta({STR:-100});
      save(); renderAll();
    }, '클릭 시 STR-100');

    // Permanents
    chips.push(`<span class="chip"><strong>별자리가이드</strong> ${inv.starGuide? '보유':'미보유'}</span>`);
    chips.push(`<span class="chip"><strong>반지</strong> ${inv.ring? '보유':'미보유'}</span>`);

    byId('inventoryChips').innerHTML = chips.join('');
  }

  /* ---------- Shop (Button-based) ---------- */
  function openShop(type, title, choices){
    SHOP.type = type; SHOP.title = title; SHOP.choices = choices;
    S.mode = 'shop';
    save(); renderAll();
  }

  function openMarket(){
    applyDelta({STR:-2, STM:-6});
    setImage(IMG.market);
    const choices = [
      {k:'tealeaf',  name:'찻잎',   price:15, add:3},
      {k:'bathbomb', name:'배스밤', price:20, add:3},
      {k:'mealkit',  name:'밀키트', price:20, add:3},
      {k:'toy',      name:'장난감', price:20, add:3},
    ];
    openShop('market','슈퍼', choices);
  }

  function openBookstore(){
    applyDelta({STR:-1, STM:-4});
    setImage(IMG.book);
    const choices = [
      {k:'problem',        name:'문제지',       price:12,  add:3},
      {k:'movieTicket',    name:'영화티켓',     price:24,  add:3},
      {k:'amusementTicket',name:'유원지티켓',   price:36,  add:3},
      {k:'starGuide',      name:'별자리가이드', price:50,  add:1, permanent:true},
      {k:'ring',           name:'반지',         price:500,add:1, permanent:true, requireLevel:8},
    ];
    openShop('book','서점', choices);
  }

  function openPharmacy(){
    applyDelta({STR:-3, STM:0});
    setImage(IMG.pharm);
    const choices = [
      {k:'energyDrink',   name:'피로회복제', price:100, add:1},
      {k:'antidepressant',name:'항우울제',   price:100, add:1},
    ];
    openShop('pharm','약국', choices);
  }

  function renderShopPanel(){
    if (S.mode !== 'shop') return;
    const note = byId('shopNote');
    const box  = byId('shopButtons');
    note.textContent = `${SHOP.title}에서 무엇을 살까? (보유 GLD: ${S.stats.GLD})`;

    box.innerHTML = '';
    SHOP.choices.forEach((c, idx)=>{
      const btn = document.createElement('button');
      btn.id = `shopChoice_${idx}`;
      let label = `${c.name} (GLD ${c.price})`;
      if (!c.permanent){ label += ` +${c.add}`; }
      if (c.permanent){ label += ' · 영구'; }
      if (c.requireLevel){ label += ` · L${c.requireLevel}+`; }

      btn.textContent = label;

      let canBuy = true;
      let reason = [];
      if (S.stats.GLD < c.price) { canBuy = false; reason.push('GLD 부족'); }
      if (c.requireLevel && S.level < c.requireLevel) { canBuy = false; reason.push(`L${c.requireLevel}+ 필요`); }
      if (c.permanent && S.inventory[c.k]) { canBuy = false; reason.push('이미 보유'); }

      btn.disabled = !canBuy;
      btn.title = canBuy ? '' : reason.join(', ');

      btn.addEventListener('click', ()=>{
        if (S.stats.GLD >= c.price) {
            S.stats.GLD -= c.price;
            if (c.permanent) {
                S.inventory[c.k] = true;
            } else {
                S.inventory[c.k] = (S.inventory[c.k] || 0) + (c.add || 1);
            }
            alert(`${c.name} 구매 완료!`);
            renderShopPanel(); // Refresh shop UI after purchase
        } else {
            alert('GLD가 부족합니다.');
        }
      });
      box.appendChild(btn);
    });
  }

  function exitShop(){
    nextTime();
    S.mode = 'actions';
    save(); renderAll();
  }

  // ---------- Action Execution ----------
  function perform(actionId){
    const st = S.stats, inv=S.inventory, c=S.counters;
    if (S.mode !== 'actions') return;

    const A = {
      talk: ()=>{
        if (!checkBtn('actTalk')) return;
        applyDelta({AFF:+3, TRU:+2, MOT:+0, MOOD:+0.5, STR:-2, STM:-5, GLD:0});
        setImage(IMG.talk);
        if (inv.ring && !S.married){ S.married = true; alert('관계가 "부부"로 승급됐어!'); S.story.pendingQueue.unshift('married'); if (S.mode !== 'story'){ S.story.stage = S.story.pendingQueue.shift(); S.story.idx = 0; S.mode = 'story'; setStoryFrame(); save(); renderAll(); return; } }
        nextTime();
      },
      play: ()=>{
        if (!checkBtn('actPlay')) return;
        inv.toy -= 1;
        applyDelta({AFF:+5, TRU:+0, MOT:+3, MOOD:+1, STR:-1, STM:-12, GLD:-3});
        setImage(IMG.play);
        nextTime();
      },
      study: ()=>{
        if (!checkBtn('actStudy')) return;
        inv.problem -= 1;
        applyDelta({AFF:+0, TRU:+2, MOT:+8, MOOD:-0.5, STR:+6, STM:-15, GLD:0});
        setImage(IMG.study);
        nextTime();
      },
      pet: ()=>{
        if (!checkBtn('actPet')) return;
        applyDelta({AFF:+4, TRU:+2, MOT:-2, MOOD:+1, STR:-6, STM:-4, GLD:0});
        c.pet+=1; setImage(IMG.pet); nextTime();
      },
      hug: ()=>{
        if (!checkBtn('actHug')) return;
        applyDelta({AFF:+7, TRU:+3, MOT:-3, MOOD:+1.2, STR:-10, STM:-6, GLD:0});
        c.hug+=1; setImage(IMG.hug); nextTime();
      },
      kiss: ()=>{
        if (!checkBtn('actKiss')) return;
        applyDelta({AFF:+11, TRU:+3, MOT:-5, MOOD:+1.5, STR:-8, STM:-6, GLD:0});
        c.kiss+=1; setImage(IMG.kiss); nextTime();
      },
      rest: ()=>{
        applyDelta({AFF:+0, TRU:+0, MOT:+0, MOOD:+0.5, STR:-12, STM:+40, GLD:0});
        setImage(IMG.rest); nextTime();
      },
      tea: ()=>{
        if (!checkBtn('actTea')) return;
        inv.tealeaf -= 1;
        applyDelta({AFF:+1, TRU:+1, MOT:+0, MOOD:+0.7, STR:-8, STM:+20, GLD:-5});
        setImage(IMG.tea); nextTime();
      },
      sleep_sep: ()=>{
        applyDelta({AFF:+0, TRU:+0, MOT:+2, MOOD:+0, STR:-15, STM:+60, GLD:0});
        setImage(IMG.sleep_separate); skipToNextMorning();
      },
      sleep_tog: ()=>{
        if (!checkBtn('actSleepTog')) return;
        applyDelta({AFF:+4, TRU:+3, MOT:+4, MOOD:+1, STR:-20, STM:+70, GLD:0});
        setImage(IMG.sleep_together); skipToNextMorning();
      },
      work: ()=>{
        if (!checkBtn('actWork')) return;
        applyDelta({AFF:+0, TRU:+1, MOT:-2, MOOD:-0.5, STR:+12, STM:-18, GLD:+25});
        setImage(IMG.work); nextTime();
      },
      market: ()=>{ if (!checkBtn('actMarket')) return; openMarket(); },
      book:   ()=>{ if (!checkBtn('actBook')) return; openBookstore(); },
      pharm:  ()=>{ if (!checkBtn('actPharm')) return; openPharmacy(); },
      volunteer: ()=>{
        if (!checkBtn('actVolunteer')) return;
        applyDelta({AFF:+0, TRU:+4, MOT:+10, MOOD:+0.5, STR:+10, STM:-20, GLD:0});
        setImage(IMG.volunteer); nextTime();
      },
      walk: ()=>{
        if (!checkBtn('actWalk')) return;
        applyDelta({AFF:+3, TRU:+1, MOT:+2, MOOD:+0.8, STR:-6, STM:-10, GLD:0});
        setImage(IMG.walk); nextTime();
      },
      date_planetarium: ()=>{
        if (!checkBtn('actPlanetarium')) return;
        applyDelta({AFF:+10, TRU:+4, MOT:+3, MOOD:+1.2, STR:-6, STM:-14, GLD:-12});
        c.datePlanetarium += 1; setImage(IMG.date_planetarium); nextTime();
      },
      date_cinema: ()=>{
        if (!checkBtn('actCinema')) return;
        inv.movieTicket -= 1;
        applyDelta({AFF:+12, TRU:+5, MOT:+7, MOOD:+1.5, STR:-12, STM:-20, GLD:-25});
        c.dateCinema += 1; setImage(IMG.date_cinema); nextTime();
      },
      date_amusement: ()=>{
        if (!checkBtn('actAmusement')) return;
        inv.amusementTicket -= 1;
        applyDelta({AFF:+15, TRU:+6, MOT:+17, MOOD:+1.8, STR:-18, STM:-26, GLD:-60});
        c.dateAmusement += 1; setImage(IMG.date_amusement); nextTime();
      },
    };

    const fn = A[actionId];
    if (fn){ fn(); }
    tryLevelUp();
    save();
    renderAll();
  }

  // Dinner & Bath execution
  function doDinner(kind){
    if (kind==='cstore'){
      applyDelta({AFF:+1, TRU:+0, MOT:+0, MOOD:+0, STR:-2, STM:+8, GLD:-18});
      setImage(IMG.dinner_cstore);
    } else if (kind==='cook'){
      S.inventory.mealkit -= 1;
      applyDelta({AFF:+3, TRU:+2, MOT:+0, MOOD:+0.5, STR:-4, STM:+8, GLD:-8});
      setImage(IMG.dinner_cook);
    } else if (kind==='out'){
      applyDelta({AFF:+5, TRU:+2, MOT:+0, MOOD:+1, STR:-4, STM:+16, GLD:-50});
      setImage(IMG.dinner_out);
    }
    S.timeIndex = 4; S.mode = 'bath';
    save(); renderAll();
  }

  function doBath(kind){
    if (kind==='solo'){
      applyDelta({AFF:+0, TRU:+0, MOT:+0, MOOD:+0.8, STR:-12, STM:+12});
      setImage(IMG.bath_alone);
    } else if (kind==='together'){
      S.inventory.bathbomb -= 1;
      applyDelta({AFF:+6, TRU:+4, MOT:+2, MOOD:+1.3, STR:-18, STM:+12});
      setImage(IMG.bath_together);
    }
    S.timeIndex = 5; S.mode = 'actions';
    tryLevelUp();
    save(); renderAll();
  }

  // ---------- Buttons Availability ----------
  function setBtnEnabled(id, enabled, reason){
    const el = byId(id);
    if (!el) return;
    el.disabled = !enabled;
    el.title = enabled? '' : (reason||'조건 미충족');
  }

  function checkBtn(id){
    return !byId(id)?.disabled;
  }

  function refreshAvailability(){
    const st=S.stats, inv=S.inventory, lvl=S.level, mood=st.MOOD, str=st.STR, stm=st.STM;
    const holiday = isHoliday();

    setBtnEnabled('actTalk', (lvl>=1 && stm>=5 && str<=80 && mood>=-1.9), 'L1+, STM≥5, STR≤80, MOOD≥-1.9');
    setBtnEnabled('actPlay', (lvl>=1 && stm>=12 && str<=80 && mood>=-1.9 && (inv.toy||0)>=1 && st.GLD>=3), 'L1+, STM≥12, STR≤80, MOOD≥-1.9, 장난감≥1, GLD≥3');
    setBtnEnabled('actStudy', (lvl>=1 && stm>=15 && str<=80 && mood>=-1.9 && (inv.problem||0)>=1), 'L1+, STM≥15, STR≤80, MOOD≥-1.9, 문제지≥1');

    setBtnEnabled('actPet', (lvl>=2 && st.MOT>=2 && stm>=4 && str<=80 && mood>=-1.9), 'L2+, MOT≥2, STM≥4, STR≤80, MOOD≥-1.9');
    setBtnEnabled('actHug', (lvl>=4 && st.MOT>=3 && stm>=6 && str<=60 && mood>=-1.5), 'L4+, MOT≥3, STM≥6, STR≤60, MOOD≥-1.5');
    setBtnEnabled('actKiss', (lvl>=5 && st.MOT>=5 && stm>=6 && str<=40 && mood>=-1.0), 'L5+, MOT≥5, STM≥6, STR≤40, MOOD≥-1.0');

    setBtnEnabled('actRest', true, '');
    setBtnEnabled('actTea', (lvl>=1 && st.GLD>=5 && (inv.tealeaf||0)>=1), 'L1+, GLD≥5, 찻잎≥1');
    setBtnEnabled('actSleepSep', true, '');
    setBtnEnabled('actSleepTog', (lvl>=6 && str<=40 && mood>=-1.0), 'L6+, STR≤40, MOOD≥-1.0');

    setBtnEnabled('actWork', (lvl>=1 && st.MOT>=2 && stm>=18), 'L1+, MOT≥2, STM≥18');

    setBtnEnabled('actMarket', (lvl>=1 && stm>=6), 'L1+, STM≥6');
    setBtnEnabled('actBook', (lvl>=1 && stm>=4), 'L1+, STM≥4');
    setBtnEnabled('actPharm', (lvl>=1), 'L1+');

    const canVolunteer = holiday && lvl>=1 && stm>=20 && str<=60 && mood>=-1.5;
    setBtnEnabled('actVolunteer', canVolunteer, '휴일, L1+, STM≥20, STR≤60, MOOD≥-1.5');
    const canWalk = holiday && lvl>=1 && stm>=10 && str<=80;
    setBtnEnabled('actWalk', canWalk, '휴일, L1+, STM≥10, STR≤80');
    const canPlanet = holiday && lvl>=3 && stm>=14 && str<=60 && mood>=-1.5 && inv.starGuide && st.GLD>=12; // GLD 조건 추가
    setBtnEnabled('actPlanetarium', canPlanet, '휴일, L3+, STM≥14, GLD≥12, STR≤60, MOOD≥-1.5, 별자리가이드 보유');
    const canCinema = holiday && lvl>=3 && stm>=20 && str<=60 && mood>=-1.5 && st.GLD>=25 && (inv.movieTicket||0)>=1;
    setBtnEnabled('actCinema', canCinema, '휴일, L3+, STM≥20, STR≤60, MOOD≥-1.5, GLD≥25, 영화티켓≥1');
    const canAmuse = holiday && lvl>=3 && stm>=26 && str<=60 && mood>=-1.5 && st.GLD>=60 && (inv.amusementTicket||0)>=1;
    setBtnEnabled('actAmusement', canAmuse, '휴일, L3+, STM≥26, STR≤60, MOOD≥-1.5, GLD≥60, 유원지티켓≥1');

    setBtnEnabled('btnDinnerCStore', (st.GLD>=18), 'GLD≥18');
    setBtnEnabled('btnDinnerCook', (st.GLD>=8 && (inv.mealkit||0)>=1), 'GLD≥8, 밀키트≥1');
    setBtnEnabled('btnDinnerOut', (holiday && st.GLD>=50), '휴일, GLD≥50');

    setBtnEnabled('btnBathSolo', true, '');
    setBtnEnabled('btnBathTogether', (lvl>=7 && str<=40 && mood>=-1.0 && (inv.bathbomb||0)>=1), 'L7+, STR≤40, MOOD≥-1.0, 배스밤≥1');
  }

  
  // ---------- Dinner Safety (auto-skip when broke) ----------
  function enforceDinnerSafety(){
    // If currently at dinner time and cannot afford the cheapest meal (8 GLD),
    // apply penalty (STM -> 0, MOOD -> -3) and automatically skip dinner -> bath.
    if ((TIMES[S.timeIndex] === '저녁식사' || S.mode === 'dinner') && S.stats.GLD < 8){
      S.stats.STM = 0;
      S.stats.MOOD = -3;
      // move to bath phase
      S.timeIndex = 4; // '목욕'
      S.mode = 'bath';
      save();
    }
  }
// ---------- Render ----------
  function renderAll(){
    enforceDinnerSafety();
    byId('dayText').innerText = `${S.day}일째`;
    byId('timeText').innerText = TIMES[S.timeIndex];
    byId('levelText').innerText = `L${S.level}`;
    byId('marriedTag').classList.toggle('hidden', !S.married);
    byId('holidayTag').textContent = isHoliday()? '휴일':'평일';
    byId('holidayTag').classList.toggle('holiday', isHoliday());

    byId('s_aff').innerText = fmt(S.stats.AFF);
    byId('s_tru').innerText = fmt(S.stats.TRU);
    byId('s_mot').innerText = fmt(S.stats.MOT);
    byId('s_mood').innerText = fmt(S.stats.MOOD);
    byId('s_str').innerText = fmt(S.stats.STR);
    byId('s_stm').innerText = fmt(S.stats.STM);
    byId('s_gld').innerText = fmt(S.stats.GLD);

    byId('heroImg').src = S.lastImage || IMG.start;

    const panels = {
      novel: byId('novelPanel'),
      actions: byId('actionGroups'),
      dinner: byId('dinnerPanel'),
      bath: byId('bathPanel'),
      shop: byId('shopPanel')
    };

    Object.values(panels).forEach(p => p.classList.add('hidden'));

    let title = '';
    if (S.mode === 'story') {
      panels.novel.classList.remove('hidden');
      title = '에피소드';
    } else if (S.mode === 'dinner') {
      panels.dinner.classList.remove('hidden');
      title = '저녁 식사 선택';
    } else if (S.mode === 'bath') {
      panels.bath.classList.remove('hidden');
      title = '목욕 선택';
    } else if (S.mode === 'shop') {
      panels.shop.classList.remove('hidden');
      title = `상점: ${SHOP.title}`;
      renderShopPanel();
    } else { // actions
      panels.actions.classList.remove('hidden');
      title = '행동 선택';
    }
    byId('modeTitle').textContent = title;
    
    byId('holidayGroup').style.display = isHoliday()? 'block':'none';
    renderInventory();
    refreshAvailability();
  }

  // ---------- Event Bindings ----------
  function bind(){
    byId('btnNextNovel').addEventListener('click', nextStory);
    
    document.getElementById('actionGroups').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.id.startsWith('act')) {
            const actionId = e.target.id.replace('act', '').toLowerCase();
            const simpleMap = {
                talk: 'talk', play: 'play', study: 'study', pet: 'pet', hug: 'hug', kiss: 'kiss',
                rest: 'rest', tea: 'tea', sleepsep: 'sleep_sep', sleeptog: 'sleep_tog',
                work: 'work', market: 'market', book: 'book', pharm: 'pharm',
                volunteer: 'volunteer', walk: 'walk', planetarium: 'date_planetarium',
                cinema: 'date_cinema', amusement: 'date_amusement'
            };
            const finalActionId = simpleMap[actionId];
            if (finalActionId) {
                perform(finalActionId);
            }
        }
    });

    byId('btnDinnerCStore').addEventListener('click', ()=> checkBtn('btnDinnerCStore') && doDinner('cstore'));
    byId('btnDinnerCook').addEventListener('click', ()=> checkBtn('btnDinnerCook') && doDinner('cook'));
    byId('btnDinnerOut').addEventListener('click', ()=> checkBtn('btnDinnerOut') && doDinner('out'));

    byId('btnBathSolo').addEventListener('click', ()=> checkBtn('btnBathSolo') && doBath('solo'));
    byId('btnBathTogether').addEventListener('click', ()=> checkBtn('btnBathTogether') && doBath('together'));

    byId('btnShopCancel').addEventListener('click', ()=> exitShop());

    byId('btnQuickSave').addEventListener('click', ()=>{ save(); alert('저장했어.'); });
    byId('btnQuickLoad').addEventListener('click', ()=>{
      const L = load();
      if (L){ S=L; renderAll(); alert('불러왔어.'); } else { alert('세이브 데이터가 없어.'); }
    });
    byId('btnRestart').addEventListener('click', ()=>{
      if (confirm('정말 다시 시작할까? 저장 데이터가 모두 초기화돼.')){ 
        localStorage.removeItem(KEY); 
        hardReset(); 
        alert('새 게임을 시작했어.'); 
      }
    });

    window.addEventListener('resize', refreshAvailability);
    document.addEventListener('visibilitychange', ()=>{ if (!document.hidden) refreshAvailability(); });
  }

  // ---------- Initial ----------
  preloadAllImages();
  bind();

  if (!load()){
    S.mode='story';
    S.story.stage='intro';
    S.story.idx=0;
    setStoryFrame();
  } else {
    renderAll();
  }
  
  save();

})();
</script>
</body>
</html>
e {
    renderAll();
  }
  
  save();

})();
</script>
</body>
</html>
